---
layout: post
title: 玄人もすなる第22回シェル芸勉強会といふものを、素人もしてみむとて、するなり
permalink: /2015-05-09-01/
---

はじめに
--------

4月30日(土)に開催された「[第22回シェル芸勉強会　大阪サテライト - シェル芸勉強会 大阪サテライト](https://5f01b3bc1d81c1fae2378cdc89.doorkeeper.jp/events/42550)」に参加しました。

参加人数は約20名におよび、大阪サテライトとしては今までにない規模の勉強会となりました。

これは朝10時から夜の20時頃までの、約10時間にわたるsh行の記録です。

### メイン会場および他サテライト会場: ###

* [jus共催、第4回初心者向け詐称疑惑午前のシェル勉強会/第22回ゴールデンウィークの存在疑惑シェル芸勉強会 - USP友の会](https://usptomo.doorkeeper.jp/events/41629)
* [福岡サテライト会場：第22回シェル芸勉強会](https://atnd.org/events/76643)

### 各会場の様子: ###

* [jus共催、第4回初心者向け詐称疑惑午前のシェル勉強会/第22回ゴールデンウィークの存在疑惑シェル芸勉強会 - Togetterまとめ](http://togetter.com/li/969436)
* [「第22回シェル芸勉強会　大阪サテライト」レポート - くんすとの備忘録](http://kunst1080.hatenablog.com/entry/2016/05/01/130621)
* [第22回シェル芸勉強会へ遠隔参加 - 日々之迷歩](http://papiro.hatenablog.jp/entry/2016/04/30/234351)

### 問題ならびに模範解答: ###

* [【問題のみ】第22回ゴールデンウィークの存在疑惑シェル芸勉強会 - 上田ブログ](https://blog.ueda.asia/?p=8073)
* [【問題と解答】第22回ゴールデンウィークの存在疑惑シェル芸勉強会 - 上田ブログ](https://blog.ueda.asia/?p=8028)

### ライブストリーム(YouTube): ###

* [午前の部](https://youtu.be/SndqTVuQTeU)
* [午後の部](https://youtu.be/tf3dRVlmbcs)

------------------------------------------------------------------------------

午前の部
--------

### 「シェルがコマンドを処理する前にしていること」 ###

#### 講師: ####

鳥海　秀一　さん(USP友の会)

#### 内容: ####

1. 入力したコマンドラインをシェルがどのように解釈しているのか
2. **eval**コマンドの使い方とその応用

#### 感想: ####

シェル芸を実行、あるいはシェルスクリプトを書く際、コマンドラインが次のように解釈されていくことを知ることができ、今後のシェルライフに大きく役立ちそうです。

1. トークン分割
2. エイリアス展開
3. その他の展開
    * ブレース展開
    * チルダ展開
    * パラメータ展開
    * コマンド置換
    * 算術式展開
    * プロセス置換
    * 単語の分割
    * パス名展開
    * クオートの削除
4. コマンド検索

そして、**eval**ならびに**bc**コマンドを使って[ネイピア数](https://ja.wikipedia.org/wiki/%E3%83%8D%E3%82%A4%E3%83%94%E3%82%A2%E6%95%B0)を求める

    $ eval echo 1 '+1/\(1 \*{1..'{1..20}'} \)' | bc -l
    2.71828182845904523525

も凄いものがありますが、個人的には

    $ alias eval='eval eval'
    $ eval
    [exited]

でシェルが落ちるのが最も印象に残りました。

### 「/etc/rc を読んでみる」 ###

#### 講師: ####

りゅうち　てつや　さん(USP友の会/日本UNIXユーザ会)

#### 内容: ####

1. [FreeBSD](https://www.freebsd.org/ja/)のおすすめ
2. ドキュメントの読み方および**man**コマンドの使い方
3. **rc(8)**に関連したファイルを読んでみる

#### 感想: ####

普段使っている[Debian](https://www.debian.org/index.ja.html)がシステム起動に**systemd**を利用しているため、各種**rc**スクリプトを意識することはあまりなかったのですが、もともとLinux系OSもBSD系OSとよく似た起動方法を採っていたわけで、これを機にFreeBSDにもチャレンジしてみようかと思いました。

------------------------------------------------------------------------------

昼休み
------

T.Motooka([@t_motooka](https://twitter.com/t_motooka))さんによる手書き(!)SVG/PDFの実演が行われました。

[Base64](https://ja.wikipedia.org/wiki/Base64)も手書きするという……おそるべし。

------------------------------------------------------------------------------

午後の部
--------

今回はAWKの連想配列の使い方をマスターしていないと解けない問題が多く、思いのほかこれが出来ていないことに気付かされました。

### Q1 ###

#### 問題: ####

ファイル**a**および**b**についてそれぞれの中央値を求めます。データ数が偶数個の場合は中央2つの値の平均とします。

#### 主観的難度／当日の成否: ####

★★★★☆／解答失敗

#### 解答: ####

    $ for f in a b; do echo -n "$f: "; cat "$f" | sort -n | awk '{n[NR]=$1}END{print(NR%2?n[NR/2+0.5]:(n[NR/2]+n[NR/2+1])/2)}'; done
    a: 3.5
    b: 3.4

#### 説明: ####

読み込んだレコード数を格納する特殊変数**NR**の値をキーとした連想配列に**sort -n**でソートした各行の値を代入し、パターン**END**で総読み込みレコード数が偶数であれば中央の値、奇数であれば中央2つの値の平均を出力しています。

### Q2 ###

#### 問題: ####

    $ echo カレーライス 醤油ラーメン | ...
    　　　カ
    　　　レ
    醤油ラーメン
    　　　ラ
    　　　イ
    　　　ス

のように「ー」でクロスさせます。

#### 主観的難度／当日の成否: ####

★★★★☆／解答失敗

#### 解答: ####

    $ echo カレーライス 醤油ラーメン | tr ' ' '\n' | sed '1s/./　　　&\n/g' | awk '{l[NR]=$0}END{l[3]=l[NR];for(i=1;i<7;i++){print l[i]}}'
    　　　カ
    　　　レ
    醤油ラーメン
    　　　ラ
    　　　イ
    　　　ス

#### 説明: ####

「カレーライス」の部分と「醤油ラーメン」の部分で2行に分割し、1行目の「カレーライス」を1文字ずつ全角スペース3個を加えて行に分割します。

そして、Q1と同じように特殊変数**NR**の値をキーとした連想配列に各行の値を格納し、パターン**END**で3行目の値を「醤油ラーメン」が格納されている最終行の値に入れ替えて出力します。

### Q3 ###

#### 問題: ####

ファイル**Q3**

    $ cat Q3
    aaabbb
    bababa
    aaabbb
    aaabbb
    bababa
    bbbbba

について

    $ cat Q3 | ...
    bababa  2 5
    aaabbb  1 3 4
    bbbbba  6

のように行番号を付けてコンパクトに出力します。

また、出力結果を格納したファイル**Q3.ans**から元のデータに復元します。

#### 主観的難度／当日の成否: ####

★★★★☆／解答失敗

#### 解答: ####

    $ cat Q3 | awk '{data[$1]=data[$1]" "NR}END{for(key in data){print key,data[key]}}'
    bababa  2 5
    aaabbb  1 3 4
    bbbbba  6
    $ cat Q3.ans | awk '{for(i=2;i<=NF;i++){print $1,$i}}' | sort -k2,2 | awk '{print $1}'
    aaabbb
    bababa
    aaabbb
    aaabbb
    bababa
    bbbbba

#### 説明: ####

前半・後半ともにAWK力が要求される問題でした。

前半では、キーに各行の値を、値に「行の値 行番号の繰り返し」を格納した連想配列を使って、行の値が重複した場合に行番号を追記できるようにして、パターン**END**でこの連想配列のキーと値の対を出力します。

後半では、第2フィールド以降にある数値から「行の値 行番号」を格納したテキストデータの行を各レコード行から復元し、ソートした後、行の値のみ出力します。

AWKの連想配列の使い方だけではなく、ファイルの圧縮・解凍の原理も学べる良い問題だと思います。

### Q4 ###

#### 問題: ####

ファイル**Q4**について、素数行目に存在するりんごとみかんの数を数えます。

    $ cat Q4
    りんご
    りんご
    みかん
    みかん
    りんご
    みかん
    りんご
    りんご

#### 主観的難度／当日の成否: ####

★★☆☆☆／解答成功

#### 解答: ####

    $ cat Q4 | paste <(seq 8 | factor) - | awk 'NF==3' | sort -k3,3 | uniq -f2 -c | awk '{print $4,$1}'
    みかん 1
    りんご 3

#### 説明: ####

まず、**paste**コマンドとプロセス置換を用いて、行番号とそれを素因数分解したものを各行の先頭に付けます。

次に、行番号が素数の場合は「行番号: 素因数1つ りんご又はみかん」のようにフィールド数が3つになっていますので、該当する行を抽出します。

そして、第3フィールドの値について出現回数を求めるために**sort -k3,3**ならびに**uniq -f2 -c**を使い、最後に「りんご又はみかん 出現回数」を出力します。

## Q5 ###

#### 問題: ####

ファイル**Q5**にある数の並びから、足して10になる並びを見つけ出します。

    $ cat Q5
    1 3 4 4 2 3 5 6 7 9 1 4

#### 主観的難度／当日の成否: ####

★★★★☆／解答失敗

#### 解答: ####

    $ cat Q5 | tr -d ' ' | sed ':A;h;:B;p;s/.$//;tB;x;s/^.//;tA;' | sed 's/./& /g' | sed '/^\(. \|\)$/d' | awk '{printf($0": ");for(n=1;n<=NF;n++){s+=$n};print s;s=0}' | sed '/: 10$/!d'
    4 4 2 : 10
    2 3 5 : 10
    9 1 : 10

#### 説明: ####

**sed**で数の組み合わせを列挙し、それらの和が10になるものを抽出・出力しています。

なお、数の組み合わせを列挙している部分

    $ cat Q5 | tr -d ' ' | sed ':A;h;:B;p;s/.$//;tB;x;s/^.//;tA;' | sed 's/./& /g' | sed '/^\(. \|\)$/d'
    1 3 4 4 2 3 5 6 7 9 1 4
    1 3 4 4 2 3 5 6 7 9 1
    1 3 4 4 2 3 5 6 7 9
    1 3 4 4 2 3 5 6 7
    1 3 4 4 2 3 5 6
    (...中略...)
    7 9 1
    7 9
    9 1 4
    9 1
    1 4

にある「**sed ':A;h;:B;p;s/.$//;tB;x;s/^.//;tA;'**」には、

1. 外側のループ用のラベル**A**を設定
2. パターンスペースに格納されている文字列をホールドスペースにコピーして保存
3. 内側のループ用のラベル**B**を設定
4. 現時点のパターンスペースを出力
5. パターンスペースから末尾の1文字を削除
6. パターンスペースにある文字が無くなるまでラベル**B**に戻って内側のループを繰り返す
7. パターンスペースにある文字が無くなったら、ホールドスペースに保存してある文字列をパターンスペースに戻す
8. 戻したパターンスペースの先頭1文字を削除
9. パターンスペースにある文字が無くなるまでラベル**A**に戻って外側のループを繰り返す

という意味があります。

そして、その後の「**sed 's/./& /g'**」は各文字の間に半角スペースを挿入、「**sed '/^\(. \|\)$/d'**」は1文字と半角スペースしか存在しない行あるいは空白行を削除するという意味になっています。

### Q6 ###

#### 問題: ####

ファイル**Q6\_1**

    $ cat Q6_1
    所謂いわゆる「Z」というものにだって、
    もっと何か表情なり印象なりがあるものだろうに、
    YのからだにXでもくっつけたなら、
    こんな感じのものになるであろうか、
    とにかく、どこという事なく、見る者をして、
    ぞっとさせ、いやな気持にさせるのだ。
    私はこれまで、こんな不思議な男の顔を見た事が、
    やはり、いちども無かった。

のX・Y・Zに対して、ファイル**Q6\_2**

    $ cat Q6_2
    X 駄馬の首
    Y 人間
    Z 死相

の内容に基づいて置き換えます。

#### 主観的難度／当日の成否: ####

★★☆☆☆／解答成功

#### 解答: ####

    $ cat Q6_2 | awk '{print "sed \"s/"$1"/"$2"/g\""}' | sed -z 's/\n/ | /g' | sed 's/^/cat Q6_1 | /' | sed 's/| $/\n/' | sh
    所謂いわゆる「死相」というものにだって、
    もっと何か表情なり印象なりがあるものだろうに、
    人間のからだに駄馬の首でもくっつけたなら、
    こんな感じのものになるであろうか、
    とにかく、どこという事なく、見る者をして、
    ぞっとさせ、いやな気持にさせるのだ。
    私はこれまで、こんな不思議な男の顔を見た事が、
    やはり、いちども無かった。

#### 説明: ####

    $ cat Q6_2 | awk '{print "sed \"s/"$1"/"$2"/g\""}' | sed -z 's/\n/ | /g' | sed 's/^/cat Q6_1 | /' | sed 's/| $/\n/'
    cat Q6_1 | sed "s/X/駄馬の首/g" | sed "s/Y/人間/g" | sed "s/Z/死相/g"

でシェル芸の文字列を生成できますので、それをパイプでシェルに渡して置換処理しています。

### Q7 ###

#### 問題: ####

明示的に端末を閉じる次のようなコマンド、例えば

* **shutdown**
* **reboot**
* **exit**
* **logout**

などを使わずに端末を閉じます。

#### 主観的難度／当日の成否: ####

★☆☆☆☆／解答成功

#### 解答: ####

    $ ps | grep -v 'PID' | awk '{print $1}' | tac | xargs kill -15

なお、これを短くした別解として

    $ ps -o pid= | tac | xargs kill -15

を挙げておきます。

#### 説明: ####

呼び出し端末と同じ端末に関連付いているプロセスのみを抽出するために**ps**をデフォルトで実行し、抽出したプロセスをすべて終了させます。

なお、最後にシェルを終了させないと端末が閉じないため、プロセスIDのリストを**xargs**に渡す前に**tac**で並び順を逆にしておく必要があります。

ちなみに、ここで挙げた解答よりもはるかにシンプルかつスマートなシェル芸があります。

    $ exec ls

このシェル芸は、指定したコマンドのプロセスでシェルのプロセスを上書きする**exec**を使うと指定したコマンドの終了と共にシェルも終了してしまうことを利用したものです。

### Q8 ###

#### 問題: ####

C++のソースファイル**Q8.cc**について、関数プロトタイプを付け加えます。

具体的には、「using namespace std;」がある行の後に「void aho(void);」と「string nazo(void);」をソースコードからコピーして挿入するということです。

#### 主観的難度／当日の成否: ####

★★★★★／解答失敗

#### 解答: ####

    $ cat Q8.cc | awk '{l[NR]=$0}/^[a-z]+ [a-z]+\(void\)$/{m[NR]=$0}END{for(i=1;i<=NR;i++){print l[i];if(l[i]=="using namespace std;"){for(j=1;j<=NR;j++){if(m[j]){print m[j]";"}}}}}'
    #include <iostream>
    #include <string>
    using namespace std;
    void aho(void);
    string nazo(void);

    void aho(void)
    {
    	cout << nazo() << endl;
    }

    string nazo(void)
    {
    	return "謎";
    }

    int main(int argc, char const* argv[])
    {
    	aho();
    	return 0;
    }

#### 説明: ####

この問題もAWKの連想配列についての知識が要求されます。

手順としては、

1. 行番号をキーとして、各行の値を連想配列**l**に格納
2. 同じく行番号をキーとして、プロトタイプ宣言に必要な行であればその値を、そうでなければ空文字列を値として連想配列**m**に格納
3. パターン**END**の外側の**for**ループで連想配列**l**に格納した値を出力
4. 連想配列**l**の要素の値が「using namespace std;」の場合、次行以降にプロトタイプ宣言を挿入。具体的には内側の**for**ループで連想配列**m**に格納した値のうち空文字列でないものを出力

のようになっています。

------------------------------------------------------------------------------

懇親会＆LT大会
--------------

ライトニングトークの発表者と内容は次の通りでした。

1. Anubis([@Anubis_369](https://twitter.com/Anubis_369))さん: Windows PowerShellによるCSVの処理について
2. 日柳 光久([@mikkun_jp](https://twitter.com/mikkun_jp)): [GIMP・Inkscape用のカラーパレット(Pantone/DIC/TOYO)を生成するシェルスクリプト](https://gist.github.com/mikkun/9192754)
3. nmrmsys([@nmrmsys](https://twitter.com/nmrmsys))さん: 「[シェル芸で使いたいjqイディオム](http://qiita.com/nmrmsys/items/5b4a4bd2e3909db161b1)」
4. T.Motooka([@t_motooka](https://twitter.com/t_motooka))さん: **jq**を使ったアマゾンウェブサービス(AWS)の管理用スクリプト・**openssl**を使った特定サイトの証明書情報を毎日確認するスクリプトなど
5. くんすと([@kunst1080](https://twitter.com/kunst1080))さん: 「[FreeBSDのススメ](http://www.slideshare.net/kunst1080/freebsd-61541786)」※[動画あり](https://youtu.be/T2ds0is7xps)
6. tanishiking([@tanishiking](https://twitter.com/tanishiking))さん: ターミナルからニコニコ動画の検索ができる[**nicoterm**](https://github.com/tanishiking/nicoterm)の解説
7. MSR([@msr386](https://twitter.com/msr386))さん: 「[代替grep速度比較](https://speakerdeck.com/msr_i386/alt-grep)」および「[CloudAtCostという買い切りVPSってどうなん?](https://speakerdeck.com/msr_i386/about-cloudatcost)」

いずれの発表もマニアックでありながら実用的で、特に**jq**はWebAPIをCLIで扱う際に欠かせないツールになるのではないかと思います。

そして発表が最後であったにもかかわらず、提供サービスの内実のとんでもなさで会場の話題を一気にさらった人柱志願者向け激安VPSの[CloudAtCost](http://www.cloudatcost.com/)が実にアヤしくて良い感じです。

------------------------------------------------------------------------------

おわりに
--------

今回の勉強会では、午前の部での「初心者向け」という言葉の意味はあくまでも講義が取り扱う領域について初心者ということであって、自分のような「普通の人」にとってそれは明らかに詐称であること、そして午後の部ではAWK力の不足、特に連想配列についての知識が乏しいことを思い知らされました。

最後に、

* くんすと([@kunst1080](https://twitter.com/kunst1080))さん
* いせ([@iseebi](https://twitter.com/iseebi))さんならびに[フェンリル株式会社 大阪本社](http://www.fenrir-inc.com/)様
* Ryuichi Ueda([@ryuichiueda](https://twitter.com/ryuichiueda))さんをはじめ、メイン会場スタッフおよび講師の皆さん

に改めてお礼を申し上げます。44GC44KK44GM44Go44GG44GU44GW44GE44G+44GX44Gf44CCCg==
